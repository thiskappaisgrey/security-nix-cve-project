
import argparse
import shutil
from pathlib import Path
from gen_nix import get_server_template, generate_nix

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Attempt Automatically generate a nix config from an exploit.py')
    parser.add_argument('-e', '--exploit', help='Specify the exploit file', required=True)
    parser.add_argument('-o', '--outdir', help='Specify the output file directory', required=True)
    args = parser.parse_args()
    exploit = Path(args.exploit)
    outdir = args.outdir
    if not exploit.exists():
        print("Exploit file doesn't exist! Can't get metadata")
        exit(1)
    # TODO: Do a bunch of stuff to get the metadata from exploit

    pythonPackages = "requests minio"
    appname = "minio"

    #TODO: Access key and other stuff can't be empty - idk how AI can deal with that..?
    config = "enable = true;listenAddress=\":9000\";\naccessKey=\"minioadmin\";secretKey=\"minioadmin\";"
    
    # The url is from the minio version
    url = "github:NixOS/nixpkgs/34bfa9403e42eece93d1a3740e9d8a02fceafbca"
    template = get_server_template(url, pythonPackages, appname, config)
    
    generate_nix(template, outdir)
    # Assume that outdir exists
    p = Path(outdir) / "exploit.py"
    # exploit.copy2(p)
    p.write_bytes(exploit.read_bytes())

