from string import Template
from pathlib import Path
import argparse

# Given the revision of nixpkgs, generate the url:
# rev: nixpkgs revision
def gen_nix_url(rev: str) -> str:
    return f"github:NixOS/nixpkgs/{rev}"

# For the basic template..
# There are ad-hoc commands if all you want is just 1 application
# but it's more scalabe if we also want to run other tools and such as well..?

# Basically - the inputs to this are just:
# url: the URL of nixpkgs contains the specific version of that pkg
# pkg: the package in question
# outdir: what directory to generate the package
def print_basic_template(url: str, pkg: str, outdir: str):
        with open("./templates/basic.nix") as f:
            s = f.read()
            template = Template(s)
            # TODO the url depends on 
            out = (template.substitute(url=f'"{url}"', pkg=pkg))
            print(f"Generating the nix file to: {outdir}")
            outpath = Path(outdir)
            if outpath.exists():
                print(f"{outdir} exists. Please remove it and try again")
                # TODO should exit here but it shouldn't matter too much
            outpath.mkdir(exist_ok=True)
            file = outpath / 'flake.nix'
            file.open('w').write(out)

            print(f"""Now run:
cd {outdir}; nix develop

To get your development environment!
            """)
            # with open(file, ) as f1: 
def print_server_template(url: str, pythonPackages: str, appname: str, config: str):
        with open("./templates/web-app.nix") as f:
            s = f.read()
            template = Template(s)
            # TODO the url depends on 
            out = (template.substitute(url=f'"{url}"', 
                                       pythonPackages  = pythonPackages, 
                                       appname = appname,
                                       config = config,
                                       portsToOpen = "9000"
                                       ))
            print(out)
            # print(f"Generating the nix file to: {outdir}")
            # outpath = Path(outdir)
            # if outpath.exists():
                # print(f"{outdir} exists. Please remove it and try again")
                # TODO should exit here but it shouldn't matter too much
            # outpath.mkdir(exist_ok=True)
            # file = outpath / 'flake.nix'
            # file.open('w').write(out)

#             print(f"""Now run:
# cd {outdir}; nix develop
#
# To get your development environment!
#             """)
if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Attempt Automatically generate a nix config from an exploit.py')
    parser.add_argument('-e', '--exploit', help='Specify the exploit file', required=True)
    parser.add_argument('-o', '--outdir', help='Specify the output file directory', required=True)
    args = parser.parse_args()
    exploit = args.exploit
    outdir = args.outdir

    print(exploit)
    print(outdir)

    # Example:
    # curl 8.0.1 needs nixpkgs at revision: 8cad3dbe48029cb9def5cdb2409a6c80d3acfe2e
    # pythonPackages = "requests minio"
    # appname = "minio"
    # config = "enable = true;listenAddress=\":9000\";\naccessKey=\"minioadmin\";secretKey=\"minioadmin\";"
    # url = "github:NixOS/nixpkgs/34bfa9403e42eece93d1a3740e9d8a02fceafbca"
    # print_server_template(url, pythonPackages, appname, config)
